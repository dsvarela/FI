clear; clf; clc;
%% A1
load('calibration.mat')
close all
% a)
% Average over all vectors
y_avg = sum(y,2)/7;
% Subtract average from measurements
e = y- y_avg;

% b)
% E[y_m,k] = E[\tau_k] + E[d/c] + E[b_m] + E[e_(m,k)]
% E[y_m,k] - E[\tau_k] - E[d/c] =  E[b_m] + 0
% E[e_m,k] = E[b_m];
biases = mean(e); % Expected Values, E[y], for each microphone based on error.

%c) Since b_m is deterministic, the variance of the error is
%going to be the variance of e_(m_k)
vars = diag(var(e));
stds = diag(std(e));
% Notes: When we eventually need to choose wheights for each microphone,
% we should base them on the variance of each of them. Higher variances
% need to be weighed less than higher ones.

%d) choose microphone 1
[N, l] = hist(e(:,1),20);
Wb=l(2)-l(1); % Bin width
Ny = length(e); % Nr of samples
% bar(l, N/(Ny*Wb));


%% A2
load('experiment.mat')
maxiter = 100;
th_hat = zeros(length(y),3);
diagP = zeros(length(y),3);
% initial estimate of theta
th_hat0 = [10 60 0];
for k = 1:size(y,1)
    % non linear LS estimate 
    [th_hat(k,:),diagP(k,:)] = nls(y(k,:),biases,vars,th_hat0,maxiter,mic_locations*100);
end
plotresults(th_hat(:,1:2)'/100,diagP(:,1:2)/100^2,mic_locations')

%% A3

%% A4
A = eye(3); B = [0 0 1]'; u = 0.5;
Q = zeros(3,3);
R = vars;
diagPp = zeros(length(y),2);
% Predicted States
th_p4 = zeros(3,length(y));
% Corrected States
th_c4 = zeros(3,length(y));
% Vector to store values of the Kalman Filter for Question Five.
K = zeros(3,7);

th_0 = [.1;.6;0];
Pc = zeros(3,3);
% First Prediction
th_p4(:,1) = A*th_0 + B*u; % Predicted States
Pp = A*Pc*A' + diag(diagP(k,:)); % Predicted Covariance Matrices
for k = 1:length(y)
    yk_ub = y(k,:)' - biases';
    Q = sqrt(diag(diagP(k,:)));
 [th_p4(:,k+1), th_c4(:,k), Pp] = ekf(yk_ub,Q,R,th_p4(:,k), Pp,mic_locations*100);
 diagPp(k,:) = [Pp(1,1), Pp(2,2)];
end
figure;
plotresults(th_p4(1:2,1:end-1)/100,diagPp.^2,mic_locations')


%% Functions
function [th_p4_, th_c4, Pp_] = ekf(yk_ub,Q,R,th_p4,Pp,mic_locations)
    A = eye(3); B = [0 0 1]'; u = 0.5;
    
    % Compute Kalman gain:
    H = Jacobian(th_p4, mic_locations);
    K = Pp*H'/(H*Pp*H' + R); % K is 3x7, R is mic uncertainty = stds

    % Correction of Predicted State (Measurement Update)
    th_c4 = th_p4 + K*(yk_ub - f(th_p4, mic_locations));
    Pc = Pp - K*H*Pp;

    % Prediction For the Next Step(Time Update)
    th_p4_ = A*th_c4 + B*u';
    Pp_ = A*Pc*A' + Q;
    
end

function [th_hat, diagP] = nls(yk,biases,vars,th_hat0,maxiter,mic_locations)

th_hat = th_hat0';
i = 0;
while i <= maxiter   
ftheta = f(th_hat,mic_locations);
e = yk'-biases'-ftheta;

% Linearise the model around the current estimate
dF = Jacobian(th_hat, mic_locations);

% Solve a least squares problem to compute delta_theta
del_theta = (dF'/vars*dF)\dF'/vars*e;

% Update the estimate th_hat
th_hat = th_hat+ del_theta;

% Set i = i + 1 and check for convergence
i = i+1; 
%if del_theta/th_hat <= 10^(-9)
 %  break
% end
end
diagP = diag(inv(dF'/vars*dF));
end

function dF = Jacobian(theta,mic_locations)
    c = 34300; % speed of sound in [m/s]
    dF = [(theta(1)-mic_locations(:,1))./vecnorm(theta(1:2) -  mic_locations')'/c, ...
    (theta(2)-mic_locations(:,2))./vecnorm(theta(1:2) -  mic_locations')'/c, ...
    ones(7,1)];
end

function ftheta = f(theta,mic_locations)
    c = 34300; % speed of sound in [m/s]
    ftheta =(theta(3) + vecnorm(theta(1:2)-mic_locations')/c)';
end
